<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>NonSENS - sensors monitor</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>

<body>
<table class="main" id="main">
    <tr><td style="font-size: large;">Connecting...</td></tr>
</table>

<!-- editor window -->
<div class="editor" id="editor">
    <table class="editor">
        <tr><td>Name</td><td><input id="edit-name"></input></tr>
        <tr><td>Group</td><td><input id="edit-group"></input></tr>
        <tr><td>Column</td><td><input id="edit-column"></input></tr>
        <tr><td>Min Value</td><td><input id="edit-min" pattern="^[0-9]*\.?[0-9]+></input></tr>
        <tr><td>Max Value</td><td><input id="edit-max"></input></tr>
        <tr><td>Divider</td><td><input id="edit-divider"></input></tr>
        <tr><td>Fractions</td><td><input id="edit-fractions"></input></tr>
        <tr><td>Units</td><td><input id="edit-units"></input></tr>
        <tr><td>Poll Interval</td><td><input id="edit-poll"></input></tr>
        <tr><td>Type</td><td><input id="edit-type"></input></tr>
        <tr><td>Color 0%</td><td><input id="edit-color0"></input></tr>
        <tr><td>Color 100%</td><td><input id="edit-color100"></input></tr>
        <tr><td>Disabled</td><td><input id="edit-disabled"></input></tr>
        <tr>
          <td><button onClick="closeEditor(1);">Apply</button></td>
          <td><button onClick="closeEditor(2);">Save</button></td>
          <td><button onClick="closeEditor(3);">Cancel</button></td>
        </tr>
    </table>
</div>

<script>

function closeEditor(action) {
    if (action == 1) {
        //apply
    } if (action == 2) {
        // save config
    } if (action == 3) {
        // do nothing
    }
    document.getElementById("editor").style.display = 'none';
};

function popupEditor(id) {
    var jdata = document.getElementById(id).innerHTML;
    if (jdata == null)
        return;

    var data = JSON.parse(jdata);

    document.getElementById("edit-name").value = data.name;
    document.getElementById("edit-group").value = data.group;
    document.getElementById("edit-column").value = document.getElementById(id).title;
    document.getElementById("edit-min").value = data.sensor.min;
    document.getElementById("edit-max").value = data.sensor.max;
    document.getElementById("edit-divider").value = data.sensor.divider;
    document.getElementById("edit-poll").value = data.sensor.poll;
    document.getElementById("edit-type").value = data.widget.type;
    document.getElementById("edit-units").value = data.widget.units;
    document.getElementById("edit-fractions").value = data.widget.fractions;
    document.getElementById("edit-color0").value = data.widget.color0;
    document.getElementById("edit-color100").value = data.widget.color100;
    document.getElementById("edit-disabled").value = data.disabled;

    document.getElementById("editor").style.display = 'block';
};


function loadCSS() {
    document.getElementsByTagName('head')[0].insertAdjacentHTML(
        'beforeend',
        '<link rel="stylesheet" type="text/css" href="/css/nonsens.css?'+Date.now()+'" />');
};

window.onload = function () {
    loadCSS();
};

var wsUrl = "ws://" + window.location.hostname + ":" + window.location.port + "/ws";

loop();

var socket;

async function loop() {

    while (1) {

        var reconnect = false;
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            socket.send("{}");
            reconnect = false;
        };

        socket.onmessage = function(msg) {
            const obj = JSON.parse(msg.data);
            var target = obj.target;
            var data = obj.data;
            var output = document.getElementById(target);
            if (output !== null)
                output.innerHTML = data;
            socket.send("{}");
        };

        socket.onclose = function(ev) {
            var output = document.getElementById("main");
            output.innerHTML = '<tr><td style="font-size: large;">Reconnecting...</td></tr>';
            reconnect = true;
        };

        await waitUntil(() => reconnect === true);

    };

};

async function waitUntil(condition, time = 1000) {
    while (!condition()) {
        await new Promise((resolve) => setTimeout(resolve, time));
    }
}

</script>

</body>

</html>
