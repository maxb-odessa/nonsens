<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>NonSENS - sensors monitor</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>

<body>
<table class="main" id="main">
    <tr><td style="font-size: large;">Connecting...</td></tr>
</table>

<!-- group editor -->
<div class="editor" id="group-editor">
    <form id="group-editor-form">
       <fieldset class="editor">
            <legend>Group Editor</legend>
            <input id="group-edit-id" type="hidden">
            <label for="group-edit-name">Name</label>
            <input type="text" id="group-edit-name" minlength="1" maxlength="24">
            <br>
            <label for="group-edit-column">Column number</label>
            <select id="group-edit-column"></select>
            <br>
            <label for="group-edit-totop">Move to column top</label>
            <input type="checkbox" id="group-edit-totop">
            <br>
            <label for="group-edit-remove">Remove</label>
            <input id="group-edit-remove" type="checkbox" onClick="confirmation('group-edit-remove');">
            <br>
       </fieldset>
       <button class="button" onClick="return closeGroupEditor('apply');">Apply</button>
       <button class="button" onClick="return closeGroupEditor('cancel');">Cancel</button>
    </form>
</div>


<!-- sensor editor -->
<div class="editor" id="sensor-editor">
    <form id="sensor-editor-form">
        <fieldset class="editor">
            <legend>Sensor</legend>
            <input id="sensor-edit-id" hidden>
            <label for="sensor-edit-name">Name</label>
            <input type="text" id="sensor-edit-name" minlength="0" maxlength="24">
            <br>
            <label for="sensor-edit-group">Group</label>
            <select id="sensor-edit-group"></select>
            <br>
            <label for="sensor-edit-min">Minimal Value</label>
            <input type="number" id="sensor-edit-min">
            <br>
            <label for="sensor-edit-max">Maximal Value</label>
            <input type="number" id="sensor-edit-max">
            <br>
            <label for="sensor-edit-divider">Divider</label>
            <input type="number" id="sensor-edit-divider">
            <br>
            <label for="sensor-edit-fractions">Fractions</label>
            <input type="number" id="sensor-edit-fractions">
            <br>
            <label for="sensor-edit-units">Units</label>
            <input type="text" id="sensor-edit-units" minlength="0" maxlength="12">
            <br>
            <label for="sensor-edit-poll">Poll Interval</label>
            <input type="number" id="sensor-edit-poll">
            <br>
            <label for="sensor-edit-type">Type</label>
            <input type="text" id="sensor-edit-type" placeholder="TBD">
            <br>
            <label for="sensor-edit-color0">Gauge Color 0%</label>
            <input type="color" id="sensor-edit-color0">
            <br>
            <label for="sensor-edit-color100">Gauge Color 100%</label>
            <input type="color" id="sensor-edit-color100">
            <br>
            <label for="sensor-edit-totop">Move to group top</label>
            <input type="checkbox" id="sensor-edit-totop">
            <br>
            <label for="sensor-edit-offline">Offline</label>
            <input id="sensor-edit-offline" type="checkbox">
            <br>
            <label for="sensor-edit-remove">Remove empty group</label>
            <input id="sensor-edit-remove" type="checkbox" onClick="confirmation('sensor-edit-remove');">
            <br>
        </fieldset>
        <button class="button" onClick="return closeSensorEditor('apply');">Apply</button>
        <button class="button" onClick="return closeSensorEditor('cancel');">Cancel</button>
    </form>
</div>

<script>


function confirmation(id) {
    let text = "Are you sure?";
    if (confirm(text) == true) {
        document.getElementById(id).checked = true;
    } else {
        document.getElementById(id).checked = false;
    }
}

function editGroup(id) {
    document.getElementById("group-editor").style.display = 'block';

    document.getElementById("group-edit-id").value = id;
    document.getElementById("group-edit-name").value = document.getElementById(id).getAttribute("data-group-name");
    document.getElementById("group-edit-totop").checked = false;

    // here: delete excess columns from option list
    // leave no more than #columns + 1 (new)
    document.getElementById("group-edit-column").innerHTML = ""
    var colsNum = document.getElementById("columns").getAttribute("data-columns-num");
    var col = document.getElementById(id).getAttribute("data-column");
    for (let i = 0; i <= colsNum; i++) {
        const op = document.createElement("option");
        op.value = i;
        if (i != colsNum) {
            if (i == col) {
                op.selected = true;
            }
            op.innerHTML = i+1;
        } else {
            op.innerHTML = i+1+' (new)';
        }
        document.getElementById("group-edit-column").appendChild(op);
    } 

    document.getElementById("group-edit-totop").checked = false;

    document.getElementById("group-edit-remove").checked = false;
    var groupLen = document.getElementById(id).getAttribute("data-sensors-num");
    if (groupLen > 0) {
        document.getElementById("group-edit-remove").disabled = "disabled";
    } 

    return false;
}

function closeGroupEditor(action) {
    document.getElementById("group-editor").style.display = 'none';

    // cancel
    if (action === "cancel") {
        return false;
    }

    var obj1 = new Object();
    var obj2 = new Object();

    obj2.name = document.getElementById("group-edit-name").value;

    obj2.column = Number(document.getElementById("group-edit-column").value);
    obj2.totop = Boolean(document.getElementById("group-edit-totop").checked);

    if (document.getElementById("group-edit-remove").checked) {
        obj1.action = "remove";
    }
    obj1.id = document.getElementById("group-edit-id").value;
    obj1.group = obj2;

    var js = JSON.stringify(obj1);

    socket.send(js);

    return false;
}

function editSensor(id) {
    var jdata = document.getElementById('json-'+id).innerHTML;
    if (jdata == null)
        return false;

    var data = JSON.parse(jdata);

    document.getElementById("sensor-edit-id").value = id;
    document.getElementById("sensor-edit-name").value = document.getElementById(id).getAttribute("data-sensor-name");
    var groupId = document.getElementById(id).getAttribute("data-group-id");

    document.getElementById("sensor-edit-group").innerHTML = "";
    var groups = document.getElementsByName("group");
    for (let i = 0; i < groups.length; i++) {
        const op = document.createElement("option");
        if (groups[i].value == groupId) {
            op.selected = true;
        }
        op.value = groups[i].Id
        op.innerHTML = groups[i].getAttribute("data-group-name");
        document.getElementById("sensor-edit-group").appendChild(op);
    } 

    document.getElementById("sensor-edit-min").value = data.options.min;
    document.getElementById("sensor-edit-max").value = data.options.max;
    document.getElementById("sensor-edit-divider").value = data.options.divider;
    document.getElementById("sensor-edit-poll").value = data.options.poll;
    document.getElementById("sensor-edit-type").value = data.widget.type;
    document.getElementById("sensor-edit-units").value = data.widget.units;
    document.getElementById("sensor-edit-fractions").value = data.widget.fractions;
    document.getElementById("sensor-edit-color0").value = data.widget.color0;
    document.getElementById("sensor-edit-color100").value = data.widget.color100;
    document.getElementById("sensor-edit-offline").checked = data.offline;
    document.getElementById("sensor-edit-totop").checked = false;

    document.getElementById("sensor-editor").style.display = 'block';

    return false;
};

function closeSensorEditor(action) {
    document.getElementById("sensor-editor").style.display = 'none';

    // cancel
    if (action === "cancel") {
        return false;
    }

    var obj1 = new Object();
    var obj2 = new Object();
    var obj3 = new Object();

    obj3.options = new Object();
    obj3.widget = new Object();

    obj3.name = document.getElementById("sensor-edit-name").value;
    obj3.options.min = Number(document.getElementById("sensor-edit-min").value);
    obj3.options.max = Number(document.getElementById("sensor-edit-max").value);
    obj3.options.divider = Number(document.getElementById("sensor-edit-divider").value);
    obj3.options.poll = Number(document.getElementById("sensor-edit-poll").value);
    obj3.widget.fractions = Number(document.getElementById("sensor-edit-fractions").value);
    obj3.widget.units = document.getElementById("sensor-edit-units").value;
    //obj3.widget.type = document.getElementById("sensor-edit-type").value;
    obj3.widget.color0 = document.getElementById("sensor-edit-color0").value;
    obj3.widget.color100 = document.getElementById("sensor-edit-color100").value;
    obj3.offline = Boolean(document.getElementById("sensor-edit-offline").checked);

    obj2.sensor = obj3;
    obj2.groupid = document.getElementById("sensor-edit-group").value;
    obj2.totop = Boolean(document.getElementById("sensor-edit-totop").checked);

    obj1.id = document.getElementById("sensor-edit-id").value;
    obj1.sensor = obj2;

    var js = JSON.stringify(obj1);

    socket.send(js);

    return false;
};


function saveConfig() {
    var obj = new Object();
    obj.action = "save";
    var js = JSON.stringify(obj);
    socket.send(js);

    return false;
}

function loadCSS() {
    document.getElementsByTagName('head')[0].insertAdjacentHTML(
        'beforeend',
        '<link rel="stylesheet" type="text/css" href="/css/nonsens.css?'+Date.now()+'" />');
};

window.onload = function () {
    loadCSS();
};

var wsUrl = "ws://" + window.location.hostname + ":" + window.location.port + "/ws";

loop();

var socket;

async function loop() {

    while (1) {

        var reconnect = false;
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            //socket.send("{}");
            reconnect = false;
        };

        socket.onmessage = function(msg) {
            const obj = JSON.parse(msg.data);
            var target = obj.target;
            var data = obj.data;
            var output = document.getElementById(target);
            if (output !== null)
                output.innerHTML = data;
            //socket.send("{}");
        };

        socket.onclose = function(ev) {
            var output = document.getElementById("main");
            output.innerHTML = '<tr><td style="font-size: large;">Reconnecting...</td></tr>';
            reconnect = true;
        };

        await waitUntil(() => reconnect === true);

    };

};

async function waitUntil(condition, time = 1000) {
    while (!condition()) {
        await new Promise((resolve) => setTimeout(resolve, time));
    }
}

</script>

</body>

</html>
