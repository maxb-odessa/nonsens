<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>NonSENS - sensors monitor</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>

<body>
<table class="main" id="main">
    <tr><td style="font-size: large;">Connecting...</td></tr>
</table>

<!-- sensor editor -->
<div class="editor" id="group-editor">
    <form id="group-editor-form">
       <fieldset class="editor">
            <legend>Group Editor</legend>
            <input id="group-edit-id" type="hidden">
            <br>
            <label for="group-edit-name">Name</label>
            <input type="text" id="group-edit-name" minlength="1" maxlength="24">
            <br>
            <label for="group-edit-column">Column number</label>
            <select id="group-edit-column"></select>
            <br>
            <label for="group-edit-totop">Move to column top</label>
            <input type="checkbox" id="group-edit-totop">
            <br>
            <label for="group-edit-disabled">Disable</label>
            <input type="checkbox" id="group-edit-disabled" onclick="confirmation('disabled');">
            <br>
        </fieldset>
        <button class="button" onClick="closeGroupEditor('apply');">Apply</button>
        <button class="button" onClick="closeGroupEditor('cancel');">Cancel</button>
    </form>
</div>


<!-- sensor editor -->
<div class="editor" id="sensor-editor">
    <p id="sensor-edit-id" hidden></p>
    <table class="editor">
        <tr class="editor">
            <td class="name">Name</td>
            <td class="input"><input type="text" id="sensor-edit-name" minlength="0" maxlength="24"></input></td>
            <td class="hint">*sensor name</td>
        </tr>
        <tr class="editor">
            <td class="name">Group</td>
            <td class="input"><input id="sensor-edit-group" minlength="1" maxlength="24"></input></td>
            <td class="hint">sensor group</td>
        </tr>
        <tr class="editor">
            <td class="name">Minimal Value</td>
            <td class="input"><input type="number" id="sensor-edit-min"></input></td>
            <td class="hint">minimal sensor value, i.e. 12.7</td>
        </tr>
        <tr class="editor">
            <td class="name">Maximal Value</td>
            <td class="input"><input type="number" id="sensor-edit-max"></input></td>
            <td class="hint">maximal sensor value, i.e. 3000.0</td>
        </tr>
        <tr class="editor">
            <td class="name">Divider</td>
            <td class="input"><input type="number" id="sensor-edit-divider"></input></td>
            <td class="hint">sensor value divider, i.e. 1000</td>
        </tr>
        <tr class="editor">
            <td class="name">Fractions</td>
            <td class="input"><input type="number" id="sensor-edit-fractions"></input></td>
            <td class="hint">value fractions to show, i.e. 2</td>
        </tr>
        <tr class="editor">
            <td class="name">Units</td>
            <td class="input"><input type="text" id="sensor-edit-units" minlength="0" maxlength="12"></input></td>
            <td class="hint">suffix value with units string, i.e. RPM</td>
        </tr>
        <tr class="editor">
            <td class="name">Poll Interval</td>
            <td class="input"><input type="number" id="sensor-edit-poll"></input></td>
            <td class="hint">sensor polling interval, seconds, 1.0&lt;i&lt;600.0</td>
        </tr>
        <tr class="editor">
            <td class="name">Type</td>
            <td class="input"><input id="sensor-edit-type"></input></td>
            <td class="hint">TBD</td>
        </tr>
        <tr class="editor">
            <td class="name">Color 0%</td>
            <td class="input"><input type="color" id="sensor-edit-color0"></input></td>
            <td class="hint">low sensor value color</td>
        </tr>
        <tr class="editor">
            <td class="name">Color 100%</td>
            <td class="input"><input type="color" id="sensor-edit-color100"></input></td>
            <td class="hint">high sensor value color</td>
        </tr>
        <tr class="editor">
            <td class="name">Disabled</td>
            <td class="input"><input id="sensor-edit-disabled" type="checkbox" onclick="confirmation('sensor-edit-disabled');"></input></td>
            </td>
            <td class="hint">disable this sensor</td>
        </tr>
        <tr class="editor">
            <td class="button"><button class="button" onClick="closeSensorEditor(1);">Apply</button></td>
            <td class="button"><button class="button" onClick="closeSensorEditor(3);">Cancel</button></td>
        </tr>
    </table>
</div>

<script>


function confirmation(id) {
    let text = "Are you sure?"
    if (confirm(text) == true) {
        document.getElementById(id).checked = true;
    } else {
        document.getElementById(id).checked = false;
    }
}

function editGroup(id, name, column) {
    document.getElementById("group-editor").style.display = 'block';

    document.getElementById("group-edit-id").value = id;
    document.getElementById("group-edit-name").value = name;

    // here: delete excess columns from option list
    // leave no more than #columns + 1 (new)
    var cols = document.getElementById("columns").childElementCount;
    for (let i = 0; i <= cols; i++) {
        const op = document.createElement("option")
        op.value = i;
        if (i != cols) {
            if (i == column) {
                op.selected = true
            }
            op.innerHTML = i+1;
        } else {
            op.innerHTML = i+1+' (new)';
        }
        document.getElementById("group-edit-column").appendChild(op)
    } 
}

function closeGroupEditor(action) {
    document.getElementById("group-editor").style.display = 'none';

    // cancel
    if (action == "cancel") {
        return;
    }

    var obj1 = new Object();
    var obj2 = new Object();

    obj2.name = document.getElementById("group-edit-name").value;

    obj2.column = Number(document.getElementById("group-edit-column").value);
    obj2.totop = Boolean(document.getElementById("group-edit-totop").checked);
    obj2.disabled = Boolean(document.getElementById("group-edit-disabled").checked);

    obj1.id = document.getElementById("group-edit-id").value;
    obj1.action = "apply";
    obj1.group = obj2;

    var js = JSON.stringify(obj1);

    socket.send(js);
}

function closeSensorEditor(action) {
    document.getElementById("sensor-editor").style.display = 'none';

    // cancel
    if (action == 3) {
        return;
    }

    var obj1 = new Object();
    var obj2 = new Object();
    obj2.options = new Object()
    obj2.widget = new Object()

    obj2.name = document.getElementById("sensor-edit-name").value;

    //obj2.group = document.getElementById("sensor-edit-group").value;

    obj2.options.min = Number(document.getElementById("sensor-edit-min").value);
    obj2.options.max = Number(document.getElementById("sensor-edit-max").value);
    obj2.options.divider = Number(document.getElementById("sensor-edit-divider").value);
    obj2.options.poll = Number(document.getElementById("sensor-edit-poll").value);

    obj2.widget.fractions = Number(document.getElementById("sensor-edit-fractions").value);
    obj2.widget.units = document.getElementById("sensor-edit-units").value;
    obj2.widget.type = document.getElementById("sensor-edit-type").value;
    obj2.widget.color0 = document.getElementById("sensor-edit-color0").value;
    obj2.widget.color100 = document.getElementById("sensor-edit-color100").value;

    obj2.disabled = Boolean(document.getElementById("sensor-edit-disabled").checked);

    if (action == 1) {
        obj1.action = "apply";
    } else if (action == 2) {
        obj1.action = "save";
    }

    obj1.id = document.getElementById("sensor-edit-id").innerHTML;
    obj1.sensor = obj2;

    var js = JSON.stringify(obj1);

    socket.send(js);
};

function editSensor(id, group) {
    var jdata = document.getElementById('json-'+id).innerHTML;
    if (jdata == null)
        return;

    var data = JSON.parse(jdata);

    document.getElementById("sensor-edit-id").innerHTML = id;

    document.getElementById("sensor-edit-name").value = data.name;

    document.getElementById("sensor-edit-group").value = group;

    document.getElementById("sensor-edit-min").value = data.options.min;
    document.getElementById("sensor-edit-max").value = data.options.max;
    document.getElementById("sensor-edit-divider").value = data.options.divider;
    document.getElementById("sensor-edit-poll").value = data.options.poll;
    document.getElementById("sensor-edit-type").value = data.widget.type;
    document.getElementById("sensor-edit-units").value = data.widget.units;
    document.getElementById("sensor-edit-fractions").value = data.widget.fractions;
    document.getElementById("sensor-edit-color0").value = data.widget.color0;
    document.getElementById("sensor-edit-color100").value = data.widget.color100;
    document.getElementById("sensor-edit-disabled").value = data.disabled;

    document.getElementById("sensor-editor").style.display = 'block';
};


function loadCSS() {
    document.getElementsByTagName('head')[0].insertAdjacentHTML(
        'beforeend',
        '<link rel="stylesheet" type="text/css" href="/css/nonsens.css?'+Date.now()+'" />');
};

window.onload = function () {
    loadCSS();
};

var wsUrl = "ws://" + window.location.hostname + ":" + window.location.port + "/ws";

loop();

var socket;

async function loop() {

    while (1) {

        var reconnect = false;
        socket = new WebSocket(wsUrl);

        socket.onopen = function() {
            //socket.send("{}");
            reconnect = false;
        };

        socket.onmessage = function(msg) {
            const obj = JSON.parse(msg.data);
            var target = obj.target;
            var data = obj.data;
            var output = document.getElementById(target);
            if (output !== null)
                output.innerHTML = data;
            //socket.send("{}");
        };

        socket.onclose = function(ev) {
            var output = document.getElementById("main");
            output.innerHTML = '<tr><td style="font-size: large;">Reconnecting...</td></tr>';
            reconnect = true;
        };

        await waitUntil(() => reconnect === true);

    };

};

async function waitUntil(condition, time = 1000) {
    while (!condition()) {
        await new Promise((resolve) => setTimeout(resolve, time));
    }
}

</script>

</body>

</html>
